<!DOCTYPE html>
<html>
<head>
    <title>Kimp Fun - Server Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #0B0F12; color: #fff; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #444; border-radius: 8px; }
        .pass { background: #1a4d2e; border-color: #16A34A; }
        .fail { background: #4d1a1a; border-color: #dc2626; }
        .pending { background: #4d4d1a; border-color: #F59E0B; }
        h1 { color: #F59E0B; }
        button { background: #16A34A; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin: 5px; }
        button:hover { background: #15803d; }
        pre { background: #1a1a1a; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Kimp Fun Server Diagnostic</h1>
    <p>This page will test your server configuration.</p>

    <div id="results"></div>

    <button onclick="runTests()">Run Tests</button>
    <button onclick="location.href='/'">Go to Game</button>

    <script>
        const results = document.getElementById('results');
        
        async function runTests() {
            results.innerHTML = '<p>Running tests...</p>';
            const tests = [];

            // Test 1: Basic HTML loading
            tests.push({
                name: 'HTML Page Loading',
                status: 'pass',
                message: 'This page loaded successfully'
            });

            // Test 2: Can we fetch from server?
            try {
                const response = await fetch('/');
                tests.push({
                    name: 'Server Response',
                    status: response.ok ? 'pass' : 'fail',
                    message: `HTTP ${response.status} ${response.statusText}`
                });
            } catch (err) {
                tests.push({
                    name: 'Server Response',
                    status: 'fail',
                    message: err.message
                });
            }

            // Test 3: WebSocket connection
            try {
                const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${location.host}`;
                const ws = new WebSocket(wsUrl);
                
                await new Promise((resolve, reject) => {
                    ws.onopen = () => {
                        tests.push({
                            name: 'WebSocket Connection',
                            status: 'pass',
                            message: `Connected to ${wsUrl}`
                        });
                        ws.close();
                        resolve();
                    };
                    ws.onerror = (err) => {
                        tests.push({
                            name: 'WebSocket Connection',
                            status: 'fail',
                            message: `Cannot connect to ${wsUrl}`
                        });
                        reject(err);
                    };
                    setTimeout(() => {
                        tests.push({
                            name: 'WebSocket Connection',
                            status: 'fail',
                            message: 'Connection timeout'
                        });
                        reject(new Error('Timeout'));
                    }, 5000);
                });
            } catch (err) {
                // Already added to tests
            }

            // Test 4: API endpoint
            try {
                const response = await fetch('/api/create-room', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'Test',
                        targetScore: 50,
                        maxPlayers: 24
                    })
                });
                
                if (response.ok) {
                    tests.push({
                        name: 'API Endpoint',
                        status: 'pass',
                        message: 'Create room API working'
                    });
                } else {
                    tests.push({
                        name: 'API Endpoint',
                        status: 'fail',
                        message: `HTTP ${response.status}`
                    });
                }
            } catch (err) {
                tests.push({
                    name: 'API Endpoint',
                    status: 'fail',
                    message: err.message
                });
            }

            // Display results
            results.innerHTML = tests.map(test => `
                <div class="test ${test.status}">
                    <strong>${test.status === 'pass' ? '‚úÖ' : '‚ùå'} ${test.name}</strong>
                    <p>${test.message}</p>
                </div>
            `).join('');

            // Summary
            const passed = tests.filter(t => t.status === 'pass').length;
            const failed = tests.filter(t => t.status === 'fail').length;
            
            results.innerHTML += `
                <div class="test ${failed === 0 ? 'pass' : 'fail'}">
                    <strong>Summary</strong>
                    <p>Passed: ${passed} | Failed: ${failed}</p>
                    ${failed === 0 ? '<p>‚úÖ All tests passed! Your server is working correctly.</p>' : 
                    '<p>‚ùå Some tests failed. See CLOUD-DEBUG.md for solutions.</p>'}
                </div>
            `;

            // Show diagnostic info
            results.innerHTML += `
                <div class="test pending">
                    <strong>Diagnostic Information</strong>
                    <pre>URL: ${location.href}
Protocol: ${location.protocol}
Host: ${location.host}
User Agent: ${navigator.userAgent.substring(0, 80)}...</pre>
                </div>
            `;
        }

        // Auto-run tests on load
        window.addEventListener('load', () => {
            setTimeout(runTests, 500);
        });
    </script>
</body>
</html>
